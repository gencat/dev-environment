# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.require_version ">= 2.2.19"

Vagrant.configure("2") do |config|
  config.vagrant.plugins = "vagrant-disksize"

  config.vm.box = "ubuntu/focal64"
  config.vm.box_version = "20211026.0.0"
  config.vm.box_check_update = false
  config.vm.hostname = "canigodev"
  config.disksize.size = "80GB"

  config.vm.provider "virtualbox" do |vb|
    vb.default_nic_type = "virtio"
    vb.gui = true
    vb.memory = "6124" # 6GB
    vb.cpus = 2
    vb.customize ["modifyvm", :id, "--cpuexecutioncap", "80"]

    # https://everythingshouldbevirtual.com/virtualization/vagrant-adding-a-second-hard-drive/
    swapdisk = './swapdisk.vdi'
    unless File.exist?(swapdisk)
      vb.customize ['createmedium', 'disk', '--filename', swapdisk, '--size', 8 * 1024 , '--format', 'VDI']
    end
    vb.customize ['storageattach', :id,  '--storagectl', 'SCSI', '--port', 2, '--device', 0, '--type', 'hdd', '--medium', swapdisk]

    datadisk = './datadisk.vmdk'
    unless File.exist?(datadisk)
      vb.customize ['createmedium', 'disk', '--filename', datadisk, '--size', 100 * 1024 , '--format', 'VMDK']
    end
    vb.customize ['storageattach', :id,  '--storagectl', 'SCSI', '--port', 3, '--device', 0, '--type', 'hdd', '--medium', datadisk]

    # See https://github.com/chef/bento/issues/682
    vb.customize ["modifyvm", :id, "--cableconnected1", "on"]
    # vb.customize ["modifyvm", :id, "--accelerate3d", "on"]
    vb.customize ['modifyvm', :id, '--hwvirtex', 'on']
    vb.customize ["modifyvm", :id, "--vram", "32"]

    # audio
    # vb.customize ["modifyvm", :id, "--audio", "coreaudio"]
    # vb.customize ["modifyvm", :id, "--audiocontroller", "hda"]
    vb.customize ["modifyvm", :id, "--audioout", "on"]
    vb.customize ["modifyvm", :id, "--clipboard", "bidirectional"]
    vb.customize ["modifyvm", :id, "--draganddrop", "bidirectional"]
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]

    vb.name = "CanigoDev-3.6.x"
  end

  # config.vm.provision "file", source: "resources", destination: "/tmp/resources"
  config.vm.provision "shell", path: "./provision.sh"
  # config.vm.synced_folder "resources", "/tmp/vagrant", owner: "root", group: "root"
end
